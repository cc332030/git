
.mirror: &mirror
  - env:
      REPOS: github.com
    services:
      - docker
    docker:
      build: cnb/dockerfile
    stages:
      - name: test
        script: |
          nslookup github.com || true
          nslookup @114.114.114.114 github.com || true
          nslookup @1.1.1.1 github.com || true
          dig github.com || true
          dig @114.114.114.114 github.com || true
          dig @1.1.1.1 github.com || true
          telnet github.com 22 || true
      - name: init-ssh-pre
        script: |
          curl -sL https://github.com/cc332030/linux/raw/master/script/init-ssh/init-ssh-pre.sh | sh
      - name: init-ssh
        imports: https://cnb.cool/${CNB_GROUP_SLUG}/secrets/-/blob/main/secrets.yml
        script: |
          curl -sL https://github.com/cc332030/linux/raw/master/script/init-ssh/init-ssh.sh | sh
        env:
          SSH_PRIVATE_KEY: ${SSH_PRIVATE_KEY}
      - name: mirror
        script: |
          curl -sL https://github.com/cc332030/git/raw/master/script/mirror/linux/mirror.sh | sh
        env:
          SOURCE: ${CNB_REPO_URL_HTTPS}
          REMOTES: ${REPOS}

    endStages:
      - name: init-ssh-clean
        script: |
        run: curl -sL https://github.com/cc332030/linux/raw/master/script/init-ssh/init-ssh-clean.sh | sh

"(main|master)":
  pull_request:
    - <<: *mirror
  push:
    - <<: *mirror
